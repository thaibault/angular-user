'use strict';
(function(a,b){'object'==typeof exports&&'object'==typeof module?module.exports=b(require('@angular/core'),require('angular-generic'),require('angular-generic/animation.compiled'),require('clientnode'),require('@angular/common'),require('@angular/forms'),require('@angular/material'),require('@angular/platform-browser'),require('@angular/router'),require('pouchdb-authentication/dist/pouchdb.authentication.min.js'),require('rxjs/Observable'),require('rxjs/add/observable/fromPromise')):'function'==typeof define&&define.amd?define('angular-user',['@angular/core','angular-generic','angular-generic/animation.compiled','clientnode','@angular/common','@angular/forms','@angular/material','@angular/platform-browser','@angular/router','pouchdb-authentication/dist/pouchdb.authentication.min.js','rxjs/Observable','rxjs/add/observable/fromPromise'],b):'object'==typeof exports?exports['angular-user']=b(require('@angular/core'),require('angular-generic'),require('angular-generic/animation.compiled'),require('clientnode'),require('@angular/common'),require('@angular/forms'),require('@angular/material'),require('@angular/platform-browser'),require('@angular/router'),require('pouchdb-authentication/dist/pouchdb.authentication.min.js'),require('rxjs/Observable'),require('rxjs/add/observable/fromPromise')):a['angular-user']=b(a['@angular/core'],a['angular-generic'],a['angular-generic/animation.compiled'],a.clientnode,a['@angular/common'],a['@angular/forms'],a['@angular/material'],a['@angular/platform-browser'],a['@angular/router'],a['pouchdb-authentication/dist/pouchdb.authentication.min.js'],a['rxjs/Observable'],a['rxjs/add/observable/fromPromise'])})('undefined'==typeof self?this:self,function(a,b,c,d,e,f,g,h,i,j,k,l){return function(a){function b(d){if(c[d])return c[d].exports;var e=c[d]={i:d,l:!1,exports:{}};return a[d].call(e.exports,e,e.exports,b),e.l=!0,e.exports}var c={};return b.m=a,b.c=c,b.d=function(a,c,d){b.o(a,c)||Object.defineProperty(a,c,{configurable:!1,enumerable:!0,get:d})},b.n=function(a){var c=a&&a.__esModule?function(){return a['default']}:function(){return a};return b.d(c,'a',c),c},b.o=function(a,b){return Object.prototype.hasOwnProperty.call(a,b)},b.p='',b(b.s=0)}([function(a,b,c){a.exports=c(1)},function(a,b,c){'use strict';(function(a){function j(e,a,b,c){b&&Object.defineProperty(e,a,{enumerable:b.enumerable,configurable:b.configurable,writable:b.writable,value:b.initializer?b.initializer.call(c):void 0})}function d(g,a,b,c,d){var e={};return Object.keys(c).forEach(function(b){e[b]=c[b]}),e.enumerable=!!e.enumerable,e.configurable=!!e.configurable,('value'in e||e.initializer)&&(e.writable=!0),e=b.slice().reverse().reduce(function(b,c){return c(g,a,b)||b},e),d&&void 0!==e.initializer&&(e.value=e.initializer?e.initializer.call(d):void 0,e.initializer=void 0),void 0===e.initializer&&(Object.defineProperty(g,a,e),e=null),e}function e(c){return function(){var a=c.apply(this,arguments);return new Promise(function(b,e){function c(d,i){try{var f=a[d](i),g=f.value}catch(b){return void e(b)}return f.done?void b(g):Promise.resolve(g).then(function(b){c('next',b)},function(b){c('throw',b)})}return c('next')})}}function k(c,a){if(!(c instanceof a))throw new TypeError('Cannot call a class as a function')}function f(b){return 2,function(){b.database=b.database.plugin(M.default)}}var g,h,i,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(b){return typeof b}:function(b){return b&&'function'==typeof Symbol&&b.constructor===Symbol&&b!==Symbol.prototype?'symbol':typeof b};b.__esModule=!0,b.Module=b.LoginComponent=b.AuthenticationGuard=b.AuthenticationService=void 0,b.dataAuthenticationInitializerFactory=f;var C=c(3),D=c(4),E=c(5),F=c(6),G=c(7),H=c(8),I=c(9),J=c(10),K=c(11),L=c(12),M=function(b){return b&&b.__esModule?b:{default:b}}(L),N=c(13);c(14);try{a.require('source-map-support/register')}catch(b){}var O=C.DataService.wrappableMethodNames.slice();C.DataService.wrappableMethodNames.push('getSession','login','logout');var P=b.AuthenticationService=(g=(0,G.Injectable)(),g(h=(l=i=function(){function f(a){var g=this;k(this,f),this.data=this.data,this.error=null,this.lastRequestedURL=null,this.login=this.login,this.loginName=null,this.loginNamesToDeauthenticate=new Set,this.loginPromise=this.loginPromise,this.observingDatabaseChanges=!0,this.resolveLogin=this.resolveLogin,this.session=null,this.data=a,this.login=function(){var b=e(regeneratorRuntime.mark(function c(){var f,h=0<arguments.length&&void 0!==arguments[0]?arguments[0]:'readonlymember',d=1<arguments.length&&void 0!==arguments[1]?arguments[1]:'readonlymember';return regeneratorRuntime.wrap(function(c){for(;;)switch(c.prev=c.next){case 0:if(g.loginName=null,!g.loginNamesToDeauthenticate.has(d)){c.next=3;break}return c.abrupt('return',!1);case 3:return f=void 0,c.prev=4,c.next=7,g.data.remoteConnection.login(d,h);case 7:f=c.sent,c.next=13;break;case 10:throw c.prev=10,c.t0=c['catch'](4),c.t0;case 13:if(!f){c.next=16;break}return g.loginName=d,c.abrupt('return',!0);case 16:return c.abrupt('return',!1);case 17:case'end':return c.stop();}},c,g,[[4,10]])}));return function(){return b.apply(this,arguments)}}(),this.loginPromise=new Promise(function(b){g.resolveLogin=b})}return f.prototype.checkLogin=function(){var a=e(regeneratorRuntime.mark(function a(){var g=this,c=0<arguments.length&&void 0!==arguments[0]?arguments[0]:function(c,a){return a};return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(this.data.remoteConnection){a.next=2;break}return a.abrupt('return',!0);case 2:return this.session=null,a.prev=3,a.next=6,this.data.remoteConnection.getSession();case 6:this.session=a.sent,a.next=14;break;case 9:return a.prev=9,a.t0=a['catch'](3),this.loginName=null,this.error=a.t0,a.abrupt('return',!1);case 14:if(this.error=null,!this.session.userCtx.name){a.next=26;break}if(!this.loginNamesToDeauthenticate.has(this.session.userCtx.name)){a.next=18;break}return a.abrupt('return',!1);case 18:return this.loginName=this.session.userCtx.name,this.observingDatabaseChanges&&(this.data.register(f.databaseMethodNamesToIntercept,function(){var b=e(regeneratorRuntime.mark(function d(e){return regeneratorRuntime.wrap(function(d){for(;;)switch(d.prev=d.next){case 0:return d.prev=0,d.next=3,e;case 3:e=d.sent,d.next=20;break;case 6:if(d.prev=6,d.t0=d['catch'](0),!(d.t0.hasOwnProperty('name')&&'unauthorized'===d.t0.name)){d.next=19;break}return g.loginName=null,d.next=12,g.data.stopSynchronisation();case 12:if(e=c(d.t0,e),!('object'===('undefined'==typeof e?'undefined':B(e))&&null!==e&&'then'in e)){d.next=17;break}return d.next=16,e;case 16:e=d.sent;case 17:d.next=20;break;case 19:throw d.t0;case 20:return d.abrupt('return',e);case 21:case'end':return d.stop();}},d,g,[[0,6]])}));return function(){return b.apply(this,arguments)}}()),this.data.register('logout',function(){var b=e(regeneratorRuntime.mark(function c(d){return regeneratorRuntime.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return b.prev=0,b.next=3,d;case 3:d=b.sent,b.next=9;break;case 6:throw b.prev=6,b.t0=b['catch'](0),b.t0;case 9:return g.loginName=null,b.next=12,g.data.stopSynchronisation();case 12:return b.abrupt('return',d);case 13:case'end':return b.stop();}},c,g,[[0,6]])}));return function(){return b.apply(this,arguments)}}())),a.next=22,this.resolveLogin(this.session);case 22:return a.next=24,this.data.startSynchronisation();case 24:return this.loginPromise=new Promise(function(b){g.resolveLogin=b}),a.abrupt('return',!0);case 26:return this.loginName=null,a.next=29,this.data.stopSynchronisation();case 29:return a.abrupt('return',!1);case 30:case'end':return a.stop();}},a,this,[[3,9]])}));return function(){return a.apply(this,arguments)}}(),f}(),i.databaseMethodNamesToIntercept=O,l))||h);Reflect.defineMetadata('design:paramtypes',[C.DataService],P);var Q=b.AuthenticationGuard=(m=(0,G.Injectable)(),m(n=(p=o=function(){function f(a,b,c){k(this,f),this.authentication=this.authentication,this.data=this.data,this.platformID=this.platformID,this.router=this.router,this.authentication=a,this.platformID=b,this.router=c}return f.prototype.canActivate=function(a,b){return f.skipOnServer&&(0,F.isPlatformServer)(this.platformID)||N.Observable.fromPromise(this.checkLogin(b.url))},f.prototype.canActivateChild=function(c,a){return this.canActivate(c,a)},f.prototype.checkLogin=function(){var a=e(regeneratorRuntime.mark(function a(){var g=this,c=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,d=1<arguments.length&&void 0!==arguments[1]?arguments[1]:!0;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,this.authentication.checkLogin(function(a,b){return g.router.navigate([f.loginPath]),b});case 2:if(!a.sent){a.next=4;break}return a.abrupt('return',!0);case 4:return c&&(this.authentication.lastRequestedURL=c),d&&this.router.navigate([f.loginPath]),a.abrupt('return',!1);case 7:case'end':return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}(),f}(),o.loginPath='/login',o.skipOnServer=!0,p))||n);(0,G.Inject)(G.PLATFORM_ID)(Q,null,1),Reflect.defineMetadata('design:paramtypes',[P,String,K.Router],Q);var R=b.LoginComponent=(q=(0,G.Component)({animations:[D.defaultAnimation],changeDetection:G.ChangeDetectionStrategy.OnPush,host:{"[@defaultAnimation]":'',"(window:keydown)":'$event.keyCode === keyCode.ENTER ? login() : null'},selector:'login',template:'\n        <div class="message" @defaultAnimation *ngIf="errorMessage">\n            {{errorMessage}}\n        </div>\n        <mat-form-field>\n            <input matInput [(ngModel)]="loginName" [placeholder]="loginLabel">\n            <mat-icon matSuffix>account_circle</mat-icon>\n        </mat-form-field>\n        <mat-form-field>\n            <input\n                matInput\n                [(ngModel)]="password"\n                [placeholder]="passwordLabel"\n                type="password"\n            >\n            <mat-icon matSuffix>lock</mat-icon>\n        </mat-form-field>\n        <button\n            (click)="login()"\n            @defaultAnimation\n            mat-raised-button\n            *ngIf="loginName && password"\n        >{{loginButtonLabel}}</button>\n    '}),r=(0,G.Input)(),s=(0,G.Input)(),t=(0,G.Input)(),q(u=(v=function(){function l(a,b,c,d,e,f,g){var h=this;k(this,l),this.errorMessage='',this.keyCode=this.keyCode,this.loginName='',j(this,'loginButtonLabel',w,this),j(this,'loginLabel',x,this),this.password='',j(this,'passwordLabel',y,this),this._authentication=this._authentication,this._authenticationGuard=this._authenticationGuard,this._data=this._data,this._representObject=this._representObject,this._router=this._router,this.keyCode=g.fixed.tools.keyCode,this._authentication=a,this._authenticationGuard=b,(0,F.isPlatformServer)(d)||this._authenticationGuard.checkLogin().then(function(b){b&&h._router.navigate(['/'])}),this._data=c,this._representObject=f.transform.bind(f),this._router=e}return l.prototype.login=function(){var b=e(regeneratorRuntime.mark(function b(){return regeneratorRuntime.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:if(this._data.remoteConnection){b.next=2;break}return b.abrupt('return');case 2:if(this.password&&this.login){b.next=5;break}return this.errorMessage='No credentials given.',b.abrupt('return');case 5:return this.errorMessage='',b.prev=6,b.next=9,this._authentication.login(this.password,this.loginName);case 9:b.next=15;break;case 11:return b.prev=11,b.t0=b['catch'](6),this.errorMessage=b.t0.hasOwnProperty('message')?b.t0.message:this._representObject(b.t0),b.abrupt('return');case 15:this.errorMessage='',this._router.navigateByUrl(this._authentication.lastRequestedURL||'/');case 17:case'end':return b.stop();}},b,this,[[6,11]])}));return function(){return b.apply(this,arguments)}}(),l}(),w=d(v.prototype,'loginButtonLabel',[r],{enumerable:!0,initializer:function(){return'login'}}),x=d(v.prototype,'loginLabel',[s],{enumerable:!0,initializer:function(){return'Login'}}),y=d(v.prototype,'passwordLabel',[t],{enumerable:!0,initializer:function(){return'Password'}}),v))||u);(0,G.Inject)(G.PLATFORM_ID)(R,null,3),Reflect.defineMetadata('design:paramtypes',[P,Q,C.DataService,String,K.Router,C.RepresentObjectPipe,C.UtilityService],R);var S=b.Module=(z=(0,G.NgModule)({declarations:[R],exports:[R],imports:[J.BrowserModule.withServerTransition({appId:'generic-universal'}),H.FormsModule,C.Module,I.MatButtonModule,I.MatIconModule,I.MatInputModule],providers:[Q,P,{deps:[C.DataService],multi:!0,provide:G.APP_INITIALIZER,useFactory:f}]}),z(A=function b(){k(this,b)})||A);b.default=S}).call(b,c(2)(a))},function(a){a.exports=function(a){return a.webpackPolyfill||(a.deprecate=function(){},a.paths=[],!a.children&&(a.children=[]),Object.defineProperty(a,'loaded',{enumerable:!0,get:function(){return a.l}}),Object.defineProperty(a,'id',{enumerable:!0,get:function(){return a.i}}),a.webpackPolyfill=1),a}},function(a){a.exports=b},function(a){a.exports=c},function(a){a.exports=d},function(a){a.exports=e},function(b){b.exports=a},function(a){a.exports=f},function(a){a.exports=g},function(a){a.exports=h},function(a){a.exports=i},function(a){a.exports=j},function(a){a.exports=k},function(a){a.exports=l}])});